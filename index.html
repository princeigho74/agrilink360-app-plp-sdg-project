<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AgriLink360 â€” Pan-African Marketplace</title>
<script src="https://cdn.tailwindcss.com"></script>
<script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-50">

<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;

const uid = (prefix='id') => prefix + '_' + Math.random().toString(36).slice(2,9);
const save = (k,v) => localStorage.setItem(k, JSON.stringify(v));
const load = (k,fallback) => { try { return JSON.parse(localStorage.getItem(k)) ?? fallback; } catch(e){ return fallback; } }

const AFRICAN_COUNTRIES = ["Nigeria","Ghana","Kenya","South Africa","Uganda","Egypt","Morocco","Ethiopia"]; 

const DEMO_PRODUCTS = [
  { id: 'p_1', title: 'Rice', desc: 'Long grain rice', qty: '100 bags', price: 50, location: 'Lagos, Nigeria', temp: 26, humidity: 60, farmerId: 'f_igho' },
  { id: 'p_2', title: 'Beans', desc: 'Brown beans', qty: '200 bags', price: 45, location: 'Kenya', temp: 28, humidity: 70, farmerId: 'f_lafikih' },
  { id: 'p_3', title: 'Cassava', desc: 'Fresh cassava tubers', qty: '500kg', price: 30, location: 'Accra, Ghana', temp: 29, humidity: 85, farmerId: 'f_john' },
  { id: 'p_4', title: 'Maize', desc: 'Yellow maize', qty: '150 bags', price: 40, location: 'South Africa', temp: 27, humidity: 65, farmerId: 'f_john' },
  { id: 'p_5', title: 'Yam', desc: 'White yam tubers', qty: '250kg', price: 35, location: 'Abuja, Nigeria', temp: 25, humidity: 60, farmerId: 'f_john' },
  { id: 'p_6', title: 'Plantain', desc: 'Fresh plantains', qty: '300kg', price: 20, location: 'Ughelli, Delta', temp: 24, humidity: 70, farmerId: 'f_john' },
];

if(!localStorage.getItem('ag_products')) save('ag_products', DEMO_PRODUCTS);
if(!localStorage.getItem('ag_users')) save('ag_users', [
  { id: 'f_igho', name:'Farmer Igho', email:'igho@farm.com', password:'123', type:'farmer', img:'https://raw.githubusercontent.com/princeigho74/images/main/farmer1.jpg' },
  { id: 'f_lafikih', name:'Farmer Lafikih', email:'lafikih@farm.com', password:'123', type:'farmer', img:'https://raw.githubusercontent.com/princeigho74/images/main/farmer2.jpg' },
  { id: 'f_john', name:'John', email:'john@farm.com', password:'123', type:'farmer', img:'https://raw.githubusercontent.com/princeigho74/images/main/farmer3.jpg' }
]);
if(!localStorage.getItem('ag_orders')) save('ag_orders', []);
if(!localStorage.getItem('ag_links')) save('ag_links', []);

/* ---------- Auth Component ---------- */
function Auth({ onLogin }) {
  const [mode, setMode] = useState('login');
  const [name,setName] = useState(''); const [email,setEmail] = useState(''); const [pw,setPw] = useState('');
  const [type,setType] = useState('buyer');
  const usersKey = 'ag_users';

  function register(e){ e.preventDefault();
    if(!name||!email||!pw){ alert('Fill all fields'); return; }
    const users = load(usersKey, []);
    if(users.some(u=>u.email===email)){ alert('Email already registered'); return; }
    const u = { id: uid('u'), name,email,password:pw,type,img:'https://raw.githubusercontent.com/princeigho74/images/main/default_user.jpg' };
    users.push(u); save(usersKey, users); onLogin(u); alert('Signup Successful!'); 
  }

  function login(e){ e.preventDefault();
    const users = load(usersKey, []);
    const u = users.find(x=>x.email===email && x.password===pw);
    if(!u){ alert('Invalid credentials'); return; } onLogin(u);
  }

  return (
    <div className="max-w-md mx-auto mt-10 p-6 bg-white rounded shadow">
      <h2 className="text-xl font-bold mb-4">{mode==='login'?'Login':'Register'}</h2>
      <form onSubmit={mode==='login'?login:register} className="space-y-3">
        {mode==='register' && <input value={name} onChange={e=>setName(e.target.value)} placeholder="Full name" className="w-full p-2 border rounded" />}
        <input value={email} onChange={e=>setEmail(e.target.value)} type="email" placeholder="Email" className="w-full p-2 border rounded" />
        <input value={pw} onChange={e=>setPw(e.target.value)} type="password" placeholder="Password" className="w-full p-2 border rounded" />
        {mode==='register' && (
          <select value={type} onChange={e=>setType(e.target.value)} className="w-full p-2 border rounded">
            <option value="buyer">Buyer</option><option value="farmer">Farmer</option>
          </select>
        )}
        <button type="submit" className="w-full bg-green-600 text-white py-2 rounded">{mode==='login'?'Login':'Create Account'}</button>
      </form>
      <div className="mt-3 text-sm text-center">
        {mode==='login'?(
          <span>New user? <button onClick={()=>setMode('register')} className="text-green-600">Register</button></span>
        ):(
          <span>Already registered? <button onClick={()=>setMode('login')} className="text-green-600">Login</button></span>
        )}
      </div>
    </div>
  );
}

/* ---------- Marketplace ---------- */
function Marketplace({ user, onBuy, onView, onLinkWithFarmer }) {
  const [products,setProducts] = useState(load('ag_products', DEMO_PRODUCTS));
  const [countryFilter,setCountryFilter] = useState(''); const [query,setQuery] = useState('');
  useEffect(()=> save('ag_products', products), [products]);
  const filtered = products.filter(p => (!countryFilter || p.location.includes(countryFilter)) &&
                                       (!query || p.title.toLowerCase().includes(query.toLowerCase()) || p.desc.toLowerCase().includes(query.toLowerCase())));

  return (
    <div className="max-w-6xl mx-auto p-4">
      <h2 className="text-2xl font-semibold text-green-700 mb-4">Marketplace</h2>
      <div className="flex flex-col sm:flex-row gap-2 mb-4">
        <input value={query} onChange={e=>setQuery(e.target.value)} placeholder="Search..." className="border p-2 rounded flex-1" />
        <select value={countryFilter} onChange={e=>setCountryFilter(e.target.value)} className="border p-2 rounded w-full sm:w-auto">
          <option value="">All Countries</option>
          {AFRICAN_COUNTRIES.map(c=><option key={c} value={c}>{c}</option>)}
        </select>
      </div>
      <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
        {filtered.map(p => (
          <div key={p.id} className="bg-white rounded shadow p-4 flex flex-col justify-between">
            <div className="flex justify-between items-center mb-2">
              <img src={`https://raw.githubusercontent.com/princeigho74/images/main/farmer${p.farmerId==='f_igho'?1:p.farmerId==='f_lafikih'?2:3}.jpg`} alt="Farmer" className="w-12 h-12 rounded-full" />
              <span className={`px-2 py-1 rounded text-xs ${p.temp>30?'bg-red-200 text-red-800':p.humidity>80?'bg-yellow-200 text-yellow-800':'bg-green-200 text-green-800'}`}>ðŸŒ¡{p.temp}Â°C ðŸ’§{p.humidity}%</span>
            </div>
            <h3 className="text-lg font-semibold">{p.title}</h3>
            <p className="text-sm text-gray-600">{p.desc}</p>
            <p className="text-xs text-gray-500">{p.qty} â€¢ {p.location}</p>
            <p className="mt-2 font-bold">${p.price}</p>
            <div className="mt-3 flex flex-col sm:flex-row gap-2">
              <button onClick={()=>onBuy(p)} className="flex-1 bg-green-600 text-white py-2 rounded hover:bg-green-700">Buy</button>
              <button onClick={()=>onView(p)} className="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700">View</button>
              {user.type==='buyer' && <button onClick={()=>onLinkWithFarmer(p)} className="flex-1 bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700">Link with Farmer</button>}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

/* ---------- App Root ---------- */
function App() {
  const [user,setUser] = useState(load('ag_currentUser', null));
  const handleLogin = u=>{ setUser(u); save('ag_currentUser', u); }
  const handleLogout = ()=>{ setUser(null); localStorage.removeItem('ag_currentUser'); }

  const handleBuy = p=>alert(`You bought ${p.title}`);
  const handleView = p=>alert(`Viewing ${p.title}`);
  const handleLinkWithFarmer = p=>{
    const links = load('ag_links', []);
    if(links.some(l=>l.productId===p.id && l.buyerId===user.id)){ alert('Already linked'); return; }
    links.push({ id: uid('l'), buyerId:user.id, farmerId:p.farmerId, productId:p.id, ts: Date.now() });
    save('ag_links', links); alert('Successfully linked with farmer!');
  }

  if(!user) return <Auth onLogin={handleLogin} />;

  return (
    <div>
      <header className="bg-green-600 text-white p-4 flex justify-between items-center">
        <h1 className="font-bold text-lg">AgriLink360</h1>
        <div>
          <span className="mr-4">{user.name} ({user.type})</span>
          <button onClick={handleLogout} className="bg-white text-green-600 px-2 py-1 rounded">Logout</button>
        </div>
      </header>
      <main>
        <Marketplace user={user} onBuy={handleBuy} onView={handleView} onLinkWithFarmer={handleLinkWithFarmer} />
      </main>
    </div>
  );
}

ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>
