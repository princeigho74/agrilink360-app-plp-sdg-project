<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AgriLink360 ‚Äî Pan-African Food Distribution</title>
<script src="https://cdn.tailwindcss.com"></script>
<script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://checkout.flutterwave.com/v3.js"></script>
</head>
  <h1>üåç AgriLink360 Marketplace</h1>
  
  <!-- Marketplace -->
  <div id="marketplace"></div>
  
  <!-- Payment -->
  <div id="payment"></div>
  
  <!-- IoT Monitor -->
  <h2>IoT Monitoring</h2>
  <div id="iotMonitor"></div>

  <script src="marketplace.js"></script>

<body class="bg-gray-50">
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

// Utility
const uid=(prefix='id')=>prefix+'_'+Math.random().toString(36).slice(2,9);
const currencyFmt=n=>new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(n);

// Demo pan-African products
const DEFAULT_PRODUCTS=[
  {id:uid(),title:'Rice',qty:'50kg',location:'Lagos, Nigeria',price:120,desc:'High-quality rice',sensor:{temp:25,humidity:70}},
  {id:uid(),title:'Beans',qty:'30kg',location:'Kano, Nigeria',price:80,desc:'Protein-rich beans',sensor:{temp:24,humidity:68}},
  {id:uid(),title:'Tomatoes',qty:'100kg',location:'Accra, Ghana',price:90,desc:'Fresh tomatoes',sensor:{temp:26,humidity:75}},
  {id:uid(),title:'Fish',qty:'20kg',location:'Dakar, Senegal',price:150,desc:'Fresh fish',sensor:{temp:22,humidity:80}},
  {id:uid(),title:'Cassava',qty:'100kg',location:'Abidjan, Ivory Coast',price:75,desc:'Fresh cassava',sensor:{temp:25,humidity:72}},
  {id:uid(),title:'Garri',qty:'50kg',location:'Douala, Cameroon',price:60,desc:'Quality Garri',sensor:{temp:24,humidity:70}},
  {id:uid(),title:'Onions',qty:'80kg',location:'Nairobi, Kenya',price:110,desc:'Fresh onions',sensor:{temp:23,humidity:68}},
  {id:uid(),title:'Pepper',qty:'40kg',location:'Dakar, Senegal',price:95,desc:'Hot peppers',sensor:{temp:26,humidity:75}},
  {id:uid(),title:'Maize',qty:'100kg',location:'Harare, Zimbabwe',price:100,desc:'Yellow maize',sensor:{temp:25,humidity:72}},
  {id:uid(),title:'Chicken',qty:'25kg',location:'Dar es Salaam, Tanzania',price:180,desc:'Fresh chicken',sensor:{temp:22,humidity:70}},
  {id:uid(),title:'Milk',qty:'50L',location:'Kampala, Uganda',price:120,desc:'Fresh milk',sensor:{temp:20,humidity:68}},
];

// Demo users
const DEFAULT_USERS=[
  {id:'farmer1',type:'farmer',name:'Uche Farms',email:'uche@demo.com',password:'farm123'},
  {id:'buyer1',type:'buyer',name:'Market Buyer',email:'buyer@demo.com',password:'buy123'}
];

// Toast notifications
function Toast({items,remove}){
  return (
    <div className="fixed right-4 bottom-4 w-96 space-y-2 z-50">
      {items.map(t=>(
        <div key={t.id} className="bg-white shadow p-3 rounded border-l-4" role="status" aria-live="polite">
          <div className="flex items-start justify-between">
            <div>
              <div className="font-semibold">{t.title}</div>
              <div className="text-xs text-gray-600">{t.msg}</div>
            </div>
            <div className="ml-3">
              <button aria-label="close" onClick={()=>remove(t.id)} className="text-sm text-gray-500 px-2 py-1">‚úï</button>
            </div>
          </div>
        </div>
      ))}
    </div>
  );
}

// Header
function Header({current,setCurrent,user,signout}){
  return (
    <header className="bg-white shadow sticky top-0 z-40">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">
        <div className="flex items-center space-x-3">
          <div className="w-10 h-10 rounded-md bg-green-600 text-white flex items-center justify-center font-bold">A</div>
          <div>
            <div className="text-lg font-semibold">AgriLink360</div>
            <div className="text-xs text-gray-500">Food Distribution Across Africa</div>
          </div>
        </div>
        <nav className="flex items-center space-x-3">
          <button className={`px-3 py-2 rounded ${current==='market'?'bg-green-50':''}`} onClick={()=>setCurrent('market')}>Marketplace</button>
          <button className={`px-3 py-2 rounded ${current==='iot'?'bg-green-50':''}`} onClick={()=>setCurrent('iot')}>IoT Monitor</button>
          <button className={`px-3 py-2 rounded ${current==='dashboard'?'bg-green-50':''}`} onClick={()=>setCurrent('dashboard')}>Dashboard</button>
          {user ? (
            <div className="flex items-center gap-2">
              <div className="text-sm text-gray-700">{user.name}</div>
              <button onClick={signout} className="px-3 py-1 border rounded text-sm">Sign out</button>
            </div>
          ):(
            <button onClick={()=>setCurrent('auth')} className="px-3 py-1 border rounded text-sm">Sign in / Register</button>
          )}
        </nav>
      </div>
    </header>
  );
}

// Auth
function Auth({onLogin}){
  const [mode,setMode]=useState('login');
  const [name,setName]=useState('');
  const [email,setEmail]=useState('');
  const [pw,setPw]=useState('');
  const [type,setType]=useState('farmer');

  function register(e){
    e.preventDefault();
    if(!name||!email||!pw){alert('Fill all fields');return;}
    const u={id:uid(type),name,email,password:pw,type};
    const users=JSON.parse(localStorage.getItem('users')||'[]');
    users.push(u);
    localStorage.setItem('users',JSON.stringify(users));
    onLogin(u);
  }

  function login(e){
    e.preventDefault();
    const users=JSON.parse(localStorage.getItem('users')||'[]');
    const u=users.find(x=>x.email===email && x.password===pw);
    if(!u){alert('Invalid credentials');return;}
    onLogin(u);
  }

  return (
    <div className="max-w-md mx-auto mt-8 p-6 bg-white rounded shadow">
      <h3 className="text-lg font-semibold mb-4">{mode==='login'?'Sign In':'Register'}</h3>
      <form onSubmit={mode==='login'?login:register} className="space-y-3">
        {mode==='register' && (
          <>
          <label className="block"><div className="text-xs text-gray-600">Name</div>
            <input value={name} onChange={e=>setName(e.target.value)} className="w-full p-2 border rounded"/>
          </label>
          <label className="block"><div className="text-xs text-gray-600">Account type</div>
            <select value={type} onChange={e=>setType(e.target.value)} className="w-full p-2 border rounded">
              <option value="farmer">Farmer</option>
              <option value="buyer">Buyer</option>
            </select>
          </label>
          </>
        )}
        <label className="block"><div className="text-xs text-gray-600">Email</div>
          <input type="email" value={email} onChange={e=>setEmail(e.target.value)} className="w-full p-2 border rounded"/>
        </label>
        <label className="block"><div className="text-xs text-gray-600">Password</div>
          <input type="password" value={pw} onChange={e=>setPw(e.target.value)} className="w-full p-2 border rounded"/>
        </label>
        <div className="flex justify-between items-center">
          <button type="submit" className="px-4 py-2 bg-green-600 text-white rounded">{mode==='login'?'Sign In':'Create Account'}</button>
          <button type="button" className="text-sm text-gray-600 underline" onClick={()=>setMode(mode==='login'?'register':'login')}>
            {mode==='login'?'Need account?':'Have account?'}
          </button>
        </div>
      </form>
      <div className="text-xs text-gray-500 mt-3">Demo: farmer(uche@demo.com/farm123), buyer(buyer@demo.com/buy123)</div>
    </div>
  );
}

// Marketplace
function Marketplace({products,onBuy}){
  const [query,setQuery]=useState('');
  const [filter,setFilter]=useState('');

  const filtered=products.filter(p=>{
    const matchQuery=p.title.toLowerCase().includes(query.toLowerCase()) || p.desc.toLowerCase().includes(query.toLowerCase());
    const matchLoc=!filter||p.location.includes(filter);
    return matchQuery && matchLoc;
  });

  return (
    <div className="max-w-7xl mx-auto px-4 py-6">
      <h1 className="text-3xl font-bold mb-4 text-green-700">Marketplace</h1>
      <div className="flex flex-col sm:flex-row sm:justify-between mb-4 gap-2">
        <input placeholder="Search products" value={query} onChange={e=>setQuery(e.target.value)} className="w-full sm:w-1/2 px-3 py-2 border rounded"/>
        <select value={filter} onChange={e=>setFilter(e.target.value)} className="w-full sm:w-1/4 px-3 py-2 border rounded">
          <option value="">All countries/cities</option>
          {[...new Set(products.map(p=>p.location))].map(loc=><option key={loc}>{loc}</option>)}
        </select>
      </div>
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        {filtered.map(p=>(
          <div key={p.id} className="bg-white rounded shadow p-4 flex flex-col justify-between">
            <div>
              <h2 className="text-lg font-semibold">{p.title}</h2>
              <p className="text-sm text-gray-600">{p.desc}</p>
              <p className="text-xs text-gray-500 mt-1">{p.qty} ‚Ä¢ {p.location}</p>
            </div>
            <div className="mt-2 flex justify-between items-center">
              <span className="font-bold text-green-700">{currencyFmt(p.price)}</span>
              <button onClick={()=>onBuy(p)} className="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition">Buy</button>
            </div>
          </div>
        ))}
        {filtered.length===0 && <div className="col-span-full text-center text-gray-500 p-8 bg-white rounded">No products found</div>}
      </div>
    </div>
  );
}

// IoT Monitor Mock
function IoTMonitor({products,toast}){
  const [data,setData]=useState(products.map(p=>({...p,sensor:{...p.sensor}})));

  useEffect(()=>{
    const interval=setInterval(()=>{
      setData(prev=>prev.map(p=>{
        const temp=p.sensor.temp + (Math.random()*4-2);
        const humidity=p.sensor.humidity + (Math.random()*6-3);
        if(temp>28 || humidity>75){
          toast({title:'Spoilage Alert',msg:`${p.title} in ${p.location} may spoil soon!`});
        }
        return {...p,sensor:{temp:Math.round(temp),humidity:Math.round(humidity)}};
      }));
    },4000);
    return ()=>clearInterval(interval);
  },[]);

  return (
    <div className="max-w-7xl mx-auto px-4 py-6">
      <h1 className="text-3xl font-bold mb-4 text-green-700">IoT Monitor (Mock)</h1>
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        {data.map(p=>(
          <div key={p.id} className="bg-white rounded shadow p-4">
            <h2 className="text-lg font-semibold">{p.title}</h2>
            <p className="text-sm text-gray-600">{p.qty} ‚Ä¢ {p.location}</p>
            <div className="mt-2 text-xs text-gray-700">Temp: {p.sensor.temp}¬∞C, Humidity: {p.sensor.humidity}%</div>
          </div>
        ))}
      </div>
    </div>
  );
}

// Dashboard
function Dashboard({user,products}){
  if(!user) return <div className="max-w-7xl mx-auto px-4 py-6">Please sign in to access dashboard.</div>;
  return (
    <div className="max-w-7xl mx-auto px-4 py-6">
      <h1 className="text-3xl font-bold mb-4 text-green-700">Dashboard</h1>
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        {user.type==='farmer' ? (
          products.filter(p=>p.location.includes('Nigeria')).map(p=>(
            <div key={p.id} className="bg-white rounded shadow p-4">
              <h2 className="text-lg font-semibold">{p.title}</h2>
              <p className="text-sm text-gray-600">{p.qty} ‚Ä¢ {p.location}</p>
              <div className="mt-2 text-xs text-gray-700">AI Redistribution: Suggest nearest buyers in Africa</div>
            </div>
          ))
        ):(
          <div className="col-span-full text-gray-600">Buyers dashboard will show purchased products here</div>
        )}
      </div>
    </div>
  );
}

// App
function App(){
  const [current,setCurrent]=useState('market');
  const [products,setProducts]=useState(JSON.parse(localStorage.getItem('products')||JSON.stringify(DEFAULT_PRODUCTS)));
  const [user,setUser]=useState(JSON.parse(localStorage.getItem('user')||'null'));
  const [toasts,setToasts]=useState([]);

  const addToast=t=>{
    const id=uid('toast');
    setToasts(prev=>[...prev,{...t,id}]);
    setTimeout(()=>setToasts(prev=>prev.filter(x=>x.id!==id)),5000);
  };

  const buyProduct=p=>{
    FlutterwaveCheckout({
      public_key: "FLWPUBK_TEST-xxxxxxxxxxxxxxxxxxxxx-X", // Replace with your Flutterwave key
      tx_ref: `AL360-${Date.now()}`,
      amount: p.price,
      currency: "USD",
      payment_options: "card, mobilemoney, ussd",
      customer: {
        email: user.email,
        name: user.name,
      },
      callback: function (data) {
        addToast({title:'Purchase Success',msg:`You bought ${p.title} for ${currencyFmt(p.price)}`});
      },
      onclose: function() { addToast({title:'Purchase',msg:'Payment cancelled'}); },
    });
  };

  const signout=()=>{
    setUser(null);
    localStorage.removeItem('user');
  };

  const handleLogin=u=>{
    setUser(u);
    localStorage.setItem('user',JSON.stringify(u));
    setCurrent('market');
  };

  return (
    <>
      <Header current={current} setCurrent={setCurrent} user={user} signout={signout}/>
      {current==='auth' && <Auth onLogin={handleLogin}/>}
      {current==='market' && <Marketplace products={products} onBuy={buyProduct}/>}
      {current==='iot' && <IoTMonitor products={products} toast={addToast}/>}
      {current==='dashboard' && <Dashboard user={user} products={products}/>}
      <Toast items={toasts} remove={id=>setToasts(prev=>prev.filter(t=>t.id!==id))}/>
    </>
  );
}

ReactDOM.render(<App/>,document.getElementById('root'));
</script>
</body>
</html>

