<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AgriLink360 — Pan-African Marketplace</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-50">
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;

/* ---------- Utilities ---------- */
const uid = (prefix='id') => prefix + '_' + Math.random().toString(36).slice(2,9);
const save = (k,v) => localStorage.setItem(k, JSON.stringify(v));
const load = (k, fallback) => { try { return JSON.parse(localStorage.getItem(k)) ?? fallback; } catch(e){ return fallback; } };

/* ---------- Countries ---------- */
const AFRICAN_COUNTRIES = ["Algeria","Angola","Benin","Botswana","Burkina Faso","Burundi","Cabo Verde","Cameroon",
"Central African Republic","Chad","Comoros","Congo (Brazzaville)","Congo (Kinshasa)","Djibouti","Egypt","Equatorial Guinea","Eritrea",
"Eswatini","Ethiopia","Gabon","Gambia","Ghana","Guinea","Guinea-Bissau","Ivory Coast","Kenya","Lesotho","Liberia","Libya","Madagascar",
"Malawi","Mali","Mauritania","Mauritius","Morocco","Mozambique","Namibia","Niger","Nigeria","Rwanda","Sao Tome and Principe","Senegal",
"Seychelles","Sierra Leone","Somalia","South Africa","South Sudan","Sudan","Tanzania","Togo","Tunisia","Uganda","Zambia","Zimbabwe"];

/* ---------- Demo Users ---------- */
const DEMO_USERS = [
  { id: 'u_igho', name: 'Igho', email:'igho@example.com', password:'123', type:'farmer', img:'https://raw.githubusercontent.com/princeigho74/images/main/farmer1.jpg' },
  { id: 'u_lafikih', name:'Lafikih', email:'lafikih@example.com', password:'123', type:'farmer', img:'https://raw.githubusercontent.com/princeigho74/images/main/farmer2.jpg' },
  { id: 'u_john', name:'John', email:'john@example.com', password:'123', type:'farmer', img:'https://raw.githubusercontent.com/princeigho74/images/main/farmer3.jpg' },
  { id: 'b_lagos', name:'Lagos Buyer', email:'lagosbuyer@example.com', password:'123', type:'buyer', img:'https://raw.githubusercontent.com/princeigho74/images/main/buyer1.jpg' },
  { id: 'b_kenya', name:'Kenya Buyer', email:'kenyabuyer@example.com', password:'123', type:'buyer', img:'https://raw.githubusercontent.com/princeigho74/images/main/buyer2.jpg' },
  { id: 'b_accra', name:'Accra Buyer', email:'accrabuyer@example.com', password:'123', type:'buyer', img:'https://raw.githubusercontent.com/princeigho74/images/main/buyer3.jpg' },
];

/* ---------- Demo Products ---------- */
const DEMO_PRODUCTS = [
  { id:'p_rice', title:'Rice', desc:'Long grain rice', qty:'100 bags', price:50, location:'Lagos, Nigeria', temp:26, humidity:60, farmerId:'u_igho', img:'https://raw.githubusercontent.com/princeigho74/images/main/iot1.jpg' },
  { id:'p_beans', title:'Beans', desc:'Brown beans', qty:'200 bags', price:45, location:'Kenya', temp:28, humidity:70, farmerId:'u_lafikih', img:'https://raw.githubusercontent.com/princeigho74/images/main/iot2.jpg' },
  { id:'p_cassava', title:'Cassava', desc:'Fresh cassava', qty:'500kg', price:30, location:'Accra, Ghana', temp:29, humidity:85, farmerId:'u_john', img:'https://raw.githubusercontent.com/princeigho74/images/main/iot3.jpg' },
];

/* ---------- Init LocalStorage ---------- */
if(!localStorage.getItem('ag_products')) save('ag_products', DEMO_PRODUCTS);
if(!localStorage.getItem('ag_users')) save('ag_users', DEMO_USERS);
if(!localStorage.getItem('ag_orders')) save('ag_orders', []);
if(!localStorage.getItem('ag_links')) save('ag_links', [
  { id:uid('l'), buyerId:'b_lagos', farmerId:'u_igho', productId:'p_rice' },
  { id:uid('l'), buyerId:'b_kenya', farmerId:'u_lafikih', productId:'p_beans' },
  { id:uid('l'), buyerId:'b_accra', farmerId:'u_john', productId:'p_cassava' }
]);

/* ---------- Header Component ---------- */
function Header({ current, setCurrent, user, onSignout }) {
  const [open,setOpen] = useState(false);
  const navButtons = [
    {key:'market', label:'Marketplace'},
    {key:'iot', label:'IoT Monitor'},
    {key:'contact', label:'Contact'}
  ];
  if(user?.type==='farmer') navButtons.splice(1,0,{key:'fdashboard', label:'Farmer Dashboard'});
  navButtons.push({key:'auth', label:user?'Account':'Sign in / Register'});
  return (
    <header className="bg-white shadow sticky top-0 z-40">
      <div className="max-w-6xl mx-auto px-4 flex items-center justify-between h-16">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 rounded-md bg-green-600 text-white flex items-center justify-center font-bold">A</div>
          <div>
            <div className="font-semibold">AgriLink360</div>
            <div className="text-xs text-gray-500">Reducing Food Waste • Distributing Farm Produce • Feeding Communities</div>
          </div>
        </div>
        <div className="sm:hidden">
          <button aria-label="menu" onClick={()=>setOpen(!open)} className="p-2 border rounded">☰</button>
        </div>
        <nav className={`absolute sm:static left-0 top-16 sm:top-0 w-full sm:w-auto bg-white sm:bg-transparent p-4 sm:p-0 shadow sm:shadow-none ${open?'block':'hidden'} sm:block`}>
          <div className="flex flex-col sm:flex-row sm:items-center sm:gap-2">
            {navButtons.map(n=>(
              <button key={n.key} onClick={()=>{setCurrent(n.key); setOpen(false)}} className={`px-3 py-2 rounded text-left sm:text-center ${current===n.key?'bg-green-100':''}`}>{n.label}</button>
            ))}
            {user && (
              <div className="flex items-center gap-2 mt-3 sm:mt-0 sm:ml-4">
                <div className="text-sm">{user.name} <span className="text-xs text-gray-500">({user.type})</span></div>
                <button onClick={()=>{onSignout(); setOpen(false)}} className="px-3 py-1 border rounded text-sm">Sign out</button>
              </div>
            )}
          </div>
        </nav>
      </div>
    </header>
  );
}

/* ---------- Auth Component ---------- */
function Auth({ onLogin }) {
  const [mode,setMode]=useState('login'); 
  const [name,setName]=useState(''); 
  const [email,setEmail]=useState(''); 
  const [pw,setPw]=useState(''); 
  const [type,setType]=useState('buyer');
  const usersKey='ag_users';

  function register(e){
    e.preventDefault();
    if(!name || !email || !pw){ alert('Fill all fields'); return; }
    const users=load(usersKey,[]);
    if(users.some(u=>u.email===email)){ alert('Email already registered'); return; }
    const u={id:uid('u'), name, email, password:pw, type, img:'https://raw.githubusercontent.com/princeigho74/images/main/default_user.jpg'};
    users.push(u);
    save(usersKey,users);
    onLogin(u);
    alert('Account created successfully!');
  }

  function login(e){
    e.preventDefault();
    const users=load(usersKey,[]);
    const u=users.find(x=>x.email===email && x.password===pw);
    if(!u){ alert('Invalid credentials'); return; }
    onLogin(u);
  }

  return (
    <div className="max-w-md mx-auto mt-8 p-6 bg-white rounded shadow">
      <h2 className="text-xl font-bold mb-4">{mode==='login'?'Login':'Register'}</h2>
      <form onSubmit={mode==='login'?login:register} className="space-y-3">
        {mode==='register' && <input value={name} onChange={e=>setName(e.target.value)} placeholder="Full name" className="w-full p-2 border rounded" />}
        <input value={email} onChange={e=>setEmail(e.target.value)} type="email" placeholder="Email" className="w-full p-2 border rounded" />
        <input value={pw} onChange={e=>setPw(e.target.value)} type="password" placeholder="Password" className="w-full p-2 border rounded" />
        {mode==='register' && (
          <select value={type} onChange={e=>setType(e.target.value)} className="w-full p-2 border rounded">
            <option value="buyer">Buyer</option>
            <option value="farmer">Farmer</option>
          </select>
        )}
        <button type="submit" className="w-full bg-green-600 text-white py-2 rounded">{mode==='login'?'Login':'Create Account'}</button>
      </form>
      <div className="mt-3 text-sm text-center">
        {mode==='login'?(
          <span>New user? <button onClick={()=>setMode('register')} className="text-green-600">Register</button></span>
        ):(
          <span>Already registered? <button onClick={()=>setMode('login')} className="text-green-600">Login</button></span>
        )}
      </div>
    </div>
  );
}

/* ---------- Farmer Dashboard Component (Updated) ---------- */
// ... Include the enhanced FarmerDashboard code provided in the previous step here ...

/* ---------- Marketplace Component ---------- */
// ... Keep your Marketplace code, now products have images and farmer links ...

/* ---------- IoT Monitor ---------- */
// ... Keep IotMonitor code as before ...

/* ---------- Contact ---------- */
function Contact(){ return (
  <div className="max-w-3xl mx-auto p-6 bg-white rounded shadow mt-6">
    <h2 className="text-2xl font-semibold text-green-700 mb-3">Contact</h2>
    <p>Email: <a className="text-blue-600" href="mailto:Smartxpress74@gmail.com">Smartxpress74@gmail.com</a></p>
    <p>Phone: <a className="text-blue-600" href="tel:+2348065202102">+2348065202102</a></p>
  </div>
);}

/* ---------- App Root ---------- */
function App(){
  const [current,setCurrent]=useState('market');
  const [user,setUser]=useState(load('ag_currentUser',null));

  useEffect(()=> {
    function onStorage(){ setUser(load('ag_currentUser',null)); }
    window.addEventListener('storage',onStorage);
    return ()=>window.removeEventListener('storage',onStorage);
  },[]);

  function handleLogin(u){ setUser(u); save('ag_currentUser',u); if(u.type==='farmer') setCurrent('fdashboard'); else setCurrent('market'); }
  function handleSignout(){ setUser(null); localStorage.removeItem('ag_currentUser'); setCurrent('market'); }

  function handleBuy(p){
    if(!user){ alert('Please sign in to buy.'); setCurrent('auth'); return; }
    if(user.type!=='buyer'){ alert('Only buyers may purchase.'); return; }
    const orders=load('ag_orders',[]);
    orders.push({id:uid('o'), productId:p.id, buyerId:user.id, ts:Date.now()});
    save('ag_orders',orders);
    alert('Purchase recorded (demo).');
  }

  function handleLinkWithFarmer(p){
    if(!user){ alert('Please sign in to link with a farmer.'); setCurrent('auth'); return; }
    if(user.type!=='buyer'){ alert('Only buyers can link with farmers.'); return; }
    const targetFarmerId=p.farmerId || 'unassigned';
    const links=load('ag_links',[]);
    if(links.some(l=>l.buyerId===user.id && l.farmerId===targetFarmerId)){ alert('Already linked.'); return; }
    links.push({id:uid('l'), buyerId:user.id, farmerId:targetFarmerId, productId:p.id, ts:Date.now()});
    save('ag_links',links);
    alert('Link recorded successfully!');
  }

  return (
    <div>
      <Header current={current} setCurrent={setCurrent} user={user} onSignout={handleSignout} />
      <main className="pt-4 pb-12">
        {current==='market' && <Marketplace user={user} onBuy={handleBuy} onLinkWithFarmer={handleLinkWithFarmer} onView={p=>alert(`${p.title}\n\n${p.desc}\n\nFresh & Available`)} />}
        {current==='iot' && <IotMonitor />}
        {current==='contact' && <Contact />}
        {current==='auth' && <Auth onLogin={handleLogin} />}
        {current==='fdashboard' && user?.type==='farmer' && <FarmerDashboard user={user} />}
      </main>
    </div>
  );
}

ReactDOM.render(<App />,document.getElementById('root'));
</script>
</body>
</html>
