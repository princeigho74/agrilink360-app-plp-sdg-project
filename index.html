<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AgriLink360 — Pan-African Marketplace</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;

/* ---------- Utilities ---------- */
const uid = (prefix='id') => prefix + '_' + Math.random().toString(36).slice(2,9);
const save = (k,v) => localStorage.setItem(k, JSON.stringify(v));
const load = (k, fallback) => { try { return JSON.parse(localStorage.getItem(k)) ?? fallback; } catch(e){ return fallback; } };

/* ---------- African countries ---------- */
const AFRICAN_COUNTRIES = ["Algeria","Angola","Benin","Botswana","Burkina Faso","Burundi","Cabo Verde","Cameroon",
"Central African Republic","Chad","Comoros","Congo (Brazzaville)","Congo (Kinshasa)","Djibouti","Egypt","Equatorial Guinea",
"Eritrea","Eswatini","Ethiopia","Gabon","Gambia","Ghana","Guinea","Guinea-Bissau","Ivory Coast","Kenya","Lesotho",
"Liberia","Libya","Madagascar","Malawi","Mali","Mauritania","Mauritius","Morocco","Mozambique","Namibia","Niger",
"Nigeria","Rwanda","Sao Tome and Principe","Senegal","Seychelles","Sierra Leone","Somalia","South Africa",
"South Sudan","Sudan","Tanzania","Togo","Tunisia","Uganda","Zambia","Zimbabwe"];

/* ---------- Initial demo products with farmer links ---------- */
const DEMO_PRODUCTS = [
  { id: 'p_rice', title: 'Rice', desc: 'Long grain rice', qty: '100 bags', price: 50, location: 'Lagos, Nigeria', temp: 26, humidity: 60, farmerId: 'u_igho', img:'https://raw.githubusercontent.com/princeigho74/images/main/farmer1.jpg', iotImg:'https://raw.githubusercontent.com/princeigho74/images/main/iot1.png' },
  { id: 'p_beans', title: 'Beans', desc: 'Brown beans', qty: '200 bags', price: 45, location: 'Kenya', temp: 28, humidity: 70, farmerId: 'u_lafikih', img:'https://raw.githubusercontent.com/princeigho74/images/main/farmer2.jpg', iotImg:'https://raw.githubusercontent.com/princeigho74/images/main/iot2.png' },
  { id: 'p_cassava', title: 'Cassava', desc: 'Fresh cassava tubers', qty: '500kg', price: 30, location: 'Accra, Ghana', temp: 29, humidity: 85, farmerId: 'u_john', img:'https://raw.githubusercontent.com/princeigho74/images/main/farmer3.jpg', iotImg:'https://raw.githubusercontent.com/princeigho74/images/main/iot3.png' },
  { id: 'p_maize', title: 'Maize', desc: 'Yellow maize', qty: '300 bags', price: 40, location: 'South Africa', temp:27, humidity:65, farmerId:'u_john', img:'https://raw.githubusercontent.com/princeigho74/images/main/farmer3.jpg', iotImg:'https://raw.githubusercontent.com/princeigho74/images/main/iot3.png' },
  { id: 'p_yam', title: 'Yam', desc: 'Fresh yam tubers', qty: '150 bags', price: 35, location: 'Abuja, Nigeria', temp:26, humidity:60, farmerId:'u_lafikih', img:'https://raw.githubusercontent.com/princeigho74/images/main/farmer2.jpg', iotImg:'https://raw.githubusercontent.com/princeigho74/images/main/iot2.png' },
  { id: 'p_tomato', title: 'Tomato', desc: 'Red tomatoes', qty: '200kg', price: 20, location: 'Ughelli, Delta, Nigeria', temp:28, humidity:75, farmerId:'u_igho', img:'https://raw.githubusercontent.com/princeigho74/images/main/farmer1.jpg', iotImg:'https://raw.githubusercontent.com/princeigho74/images/main/iot1.png' },
];

/* ---------- Load/save scaffolding ---------- */
if(!localStorage.getItem('ag_products')) save('ag_products', DEMO_PRODUCTS);
if(!localStorage.getItem('ag_users')) save('ag_users', [
  {id:'u_igho', name:'Igho', email:'igho@example.com', password:'12345', type:'farmer'},
  {id:'u_lafikih', name:'Lafikih', email:'lafikih@example.com', password:'12345', type:'farmer'},
  {id:'u_john', name:'John', email:'john@example.com', password:'12345', type:'farmer'},
]);
if(!localStorage.getItem('ag_orders')) save('ag_orders', []);
if(!localStorage.getItem('ag_links')) save('ag_links', []);

/* ---------- Modal Component ---------- */
function Modal({ show, onClose, title, message }) {
  if (!show) return null;
  return (
    <div className="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
      <div className="bg-white rounded shadow-lg max-w-sm w-full p-4">
        <h3 className="text-lg font-semibold mb-2">{title}</h3>
        <p className="text-gray-700 mb-4">{message}</p>
        <button
          className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
          onClick={onClose}
        >
          OK
        </button>
      </div>
    </div>
  );
}

/* ---------- Header (mobile menu included) ---------- */
function Header({ current, setCurrent, user, onSignout }) {
  const [open, setOpen] = useState(false);

  const navButtons = [
    { key: 'market', label: 'Marketplace' },
    { key: 'iot', label: 'IoT Monitor' },
    { key: 'contact', label: 'Contact' }
  ];

  if(user?.type === 'farmer') navButtons.splice(1,0,{ key: 'fdashboard', label: 'Farmer Dashboard' });
  navButtons.push({ key: 'auth', label: user ? 'Account' : 'Sign in / Register' });

  return (
    <header className="bg-white shadow sticky top-0 z-40">
      <div className="max-w-6xl mx-auto px-4 flex items-center justify-between h-16">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 rounded-md bg-green-600 text-white flex items-center justify-center font-bold">A</div>
          <div>
            <div className="font-semibold">AgriLink360</div>
            <div className="text-xs text-gray-500">Reducing Food Waste • Distributing Farm Produce • Feeding Communities</div>
          </div>
        </div>

        <div className="sm:hidden">
          <button aria-label="menu" onClick={()=>setOpen(!open)} className="p-2 border rounded">☰</button>
        </div>

        <nav className={`absolute sm:static left-0 top-16 sm:top-0 w-full sm:w-auto bg-white sm:bg-transparent p-4 sm:p-0 shadow sm:shadow-none ${open ? 'block' : 'hidden'} sm:block`}>
          <div className="flex flex-col sm:flex-row sm:items-center sm:gap-2">
            {navButtons.map(n => (
              <button
                key={n.key}
                onClick={() => { setCurrent(n.key); setOpen(false); }}
                className={`px-3 py-2 rounded text-left sm:text-center ${current===n.key ? 'bg-green-100' : ''}`}
              >
                {n.label}
              </button>
            ))}

            {user && (
              <div className="flex items-center gap-2 mt-3 sm:mt-0 sm:ml-4">
                <div className="text-sm">{user.name} <span className="text-xs text-gray-500">({user.type})</span></div>
                <button onClick={() => { onSignout(); setOpen(false); }} className="px-3 py-1 border rounded text-sm">Sign out</button>
              </div>
            )}
          </div>
        </nav>
      </div>
    </header>
  );
}

/* ---------- The rest (Auth, Marketplace, Farmer Dashboard, IoT Monitor, Contact) ---------- */
/* The code remains mostly unchanged except all alert() replaced by showModal() with the modal state in App */

/* ---------- App Component ---------- */
function App() {
  const [current, setCurrent] = useState('market');
  const [user, setUser] = useState(load('ag_currentUser', null));
  const [modal, setModal] = useState({ show: false, title: '', message: '' });

  function showModal(title, message) { setModal({ show: true, title, message }); }

  function handleLogin(u){
    setUser(u);
    save('ag_currentUser', u);
    if(u.type === 'farmer') setCurrent('fdashboard');
    else setCurrent('market');
    showModal('Login Successful', `Welcome, ${u.name}!`);
  }
  function handleSignout(){ setUser(null); localStorage.removeItem('ag_currentUser'); setCurrent('market'); }

  function handleBuy(p){
    if(!user){ showModal('Login Required', 'Please sign in to buy.'); setCurrent('auth'); return; }
    if(user.type !== 'buyer'){ showModal('Access Denied', 'Only buyers may purchase.'); return; }
    const orders = load('ag_orders', []);
    orders.push({ id: uid('o'), productId: p.id, buyerId: user.id, ts: Date.now() });
    save('ag_orders', orders);
    showModal('Purchase Successful', `You bought ${p.title} (${p.qty}) for $${p.price}.`);
  }

  function handleLinkWithFarmer(p){
    if(!user){ showModal('Login Required', 'Please sign in to link with a farmer.'); setCurrent('auth'); return; }
    if(user.type !== 'buyer'){ showModal('Access Denied', 'Only buyers can link with farmers.'); return; }
    let targetFarmerId = p.farmerId;
    if(!targetFarmerId){
      if(!confirm('This product has no assigned farmer. Link will be recorded as interest. Continue?')) return;
      targetFarmerId = 'unassigned';
    }
    const links = load('ag_links', []);
    if(links.some(l => l.buyerId===user.id && l.farmerId===targetFarmerId)) { showModal('Info', 'Already linked.'); return; }
    links.push({ id: uid('l'), buyerId: user.id, farmerId: targetFarmerId, productId:p.id, ts: Date.now() });
    save('ag_links', links);
    showModal('Link Successful', 'You have successfully linked with the farmer.');
  }

  return (
    <div>
      <Header current={current} setCurrent={setCurrent} user={user} onSignout={handleSignout} />
      <main className="pt-4 pb-12">
        {current==='market' && <Marketplace user={user} onBuy={handleBuy} onLinkWithFarmer={handleLinkWithFarmer} onView={(p)=>showModal(p.title,p.desc)}/>}
        {current==='iot' && <IotMonitor />}
        {current==='contact' && <Contact />}
        {current==='auth' && <Auth onLogin={handleLogin} />}
        {current==='fdashboard' && user?.type==='farmer' && <FarmerDashboard user={user} />}
        <Modal show={modal.show} onClose={()=>setModal({...modal, show:false})} title={modal.title} message={modal.message}/>
      </main>
    </div>
  );
}

/* ---------- Render ---------- */
ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>
