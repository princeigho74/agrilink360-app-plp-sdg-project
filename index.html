<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AgriLink360 â€” Pan-African Marketplace</title>
<script src="https://cdn.tailwindcss.com"></script>
<script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-50">
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;

/* ---------- Utilities ---------- */
const uid = (prefix='id') => prefix + '_' + Math.random().toString(36).slice(2,9);
const save = (k,v) => localStorage.setItem(k, JSON.stringify(v));
const load = (k,fallback)=>{try{return JSON.parse(localStorage.getItem(k))??fallback}catch(e){return fallback;}};

/* ---------- African countries ---------- */
const AFRICAN_COUNTRIES = ["Algeria","Angola","Benin","Botswana","Burkina Faso","Burundi","Cabo Verde","Cameroon",
"Central African Republic","Chad","Comoros","Congo (Brazzaville)","Congo (Kinshasa)","Djibouti","Egypt","Equatorial Guinea",
"Eritrea","Eswatini","Ethiopia","Gabon","Gambia","Ghana","Guinea","Guinea-Bissau","Ivory Coast","Kenya","Lesotho",
"Liberia","Libya","Madagascar","Malawi","Mali","Mauritania","Mauritius","Morocco","Mozambique","Namibia","Niger",
"Nigeria","Rwanda","Sao Tome and Principe","Senegal","Seychelles","Sierra Leone","Somalia","South Africa",
"South Sudan","Sudan","Tanzania","Togo","Tunisia","Uganda","Zambia","Zimbabwe"];

/* ---------- Demo Users & Products ---------- */
if(!localStorage.getItem('ag_users')){
  save('ag_users', [
    {id:'u_igho', name:'Igho', email:'igho@example.com', password:'123', type:'farmer'},
    {id:'u_lafikih', name:'Lafikih', email:'lafikih@example.com', password:'123', type:'farmer'},
    {id:'u_john', name:'John', email:'john@example.com', password:'123', type:'farmer'}
  ]);
}
if(!localStorage.getItem('ag_products')){
  save('ag_products', [
    { id: 'p_rice', title: 'Rice', desc: 'Long grain rice', qty: '100 bags', price: 50, location: 'Lagos, Nigeria', temp:26, humidity:60, farmerId:'u_igho', img:'https://raw.githubusercontent.com/princeigho74/images/main/farmer1.jpg', iotImg:'https://raw.githubusercontent.com/princeigho74/images/main/iot1.png' },
    { id: 'p_beans', title: 'Beans', desc: 'Brown beans', qty: '200 bags', price: 45, location: 'Kenya', temp:28, humidity:70, farmerId:'u_lafikih', img:'https://raw.githubusercontent.com/princeigho74/images/main/farmer2.jpg', iotImg:'https://raw.githubusercontent.com/princeigho74/images/main/iot2.png' },
    { id: 'p_cassava', title: 'Cassava', desc: 'Fresh cassava', qty: '500kg', price: 30, location: 'Accra, Ghana', temp:29, humidity:85, farmerId:'u_john', img:'https://raw.githubusercontent.com/princeigho74/images/main/farmer3.jpg', iotImg:'https://raw.githubusercontent.com/princeigho74/images/main/iot3.png' },
    { id:'p_maize', title:'Maize', desc:'Yellow maize', qty:'300 bags', price:40, location:'South Africa', temp:27, humidity:65, farmerId:'u_john', img:'https://raw.githubusercontent.com/princeigho74/images/main/farmer3.jpg', iotImg:'https://raw.githubusercontent.com/princeigho74/images/main/iot3.png' },
    { id:'p_yam', title:'Yam', desc:'Fresh yam tubers', qty:'150 bags', price:35, location:'Abuja, Nigeria', temp:26, humidity:60, farmerId:'u_lafikih', img:'https://raw.githubusercontent.com/princeigho74/images/main/farmer2.jpg', iotImg:'https://raw.githubusercontent.com/princeigho74/images/main/iot2.png' },
    { id:'p_tomato', title:'Tomato', desc:'Red tomatoes', qty:'200kg', price:20, location:'Ughelli, Delta, Nigeria', temp:28, humidity:75, farmerId:'u_igho', img:'https://raw.githubusercontent.com/princeigho74/images/main/farmer1.jpg', iotImg:'https://raw.githubusercontent.com/princeigho74/images/main/iot1.png' }
  ]);
}

if(!localStorage.getItem('ag_orders')) save('ag_orders', []);
if(!localStorage.getItem('ag_links')) save('ag_links', []);

/* ---------- Modal ---------- */
function Modal({show, onClose, title, message}) {
  if(!show) return null;
  return (
    <div className="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
      <div className="bg-white rounded shadow-lg max-w-sm w-full p-4">
        <h3 className="text-lg font-semibold mb-2">{title}</h3>
        <p className="text-gray-700 mb-4">{message}</p>
        <button className="bg-green-600 text-white px-4 py-2 rounded" onClick={onClose}>OK</button>
      </div>
    </div>
  );
}

/* ---------- Header ---------- */
function Header({ current, setCurrent, user, onSignout }) {
  const [open, setOpen] = useState(false);
  const navButtons = [
    {key:'market', label:'Marketplace'},
    {key:'iot', label:'IoT Monitor'},
    {key:'contact', label:'Contact'}
  ];
  if(user?.type==='farmer') navButtons.splice(1,0,{key:'fdashboard', label:'Farmer Dashboard'});
  navButtons.push({key:'auth', label:user?'Account':'Sign in / Register'});

  return (
    <header className="bg-white shadow sticky top-0 z-40">
      <div className="max-w-6xl mx-auto px-4 flex items-center justify-between h-16">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 rounded-md bg-green-600 text-white flex items-center justify-center font-bold">A</div>
          <div>
            <div className="font-semibold">AgriLink360</div>
            <div className="text-xs text-gray-500">Reducing Food Waste â€¢ Distributing Farm Produce â€¢ Feeding Communities</div>
          </div>
        </div>
        <div className="sm:hidden">
          <button aria-label="menu" onClick={()=>setOpen(!open)} className="p-2 border rounded">â˜°</button>
        </div>
        <nav className={`absolute sm:static left-0 top-16 sm:top-0 w-full sm:w-auto bg-white sm:bg-transparent p-4 sm:p-0 shadow sm:shadow-none ${open?'block':'hidden'} sm:block`}>
          <div className="flex flex-col sm:flex-row sm:items-center sm:gap-2">
            {navButtons.map(n=>(
              <button key={n.key} onClick={()=>{setCurrent(n.key); setOpen(false);}} className={`px-3 py-2 rounded text-left sm:text-center ${current===n.key?'bg-green-100':''}`}>{n.label}</button>
            ))}
            {user && (
              <div className="flex items-center gap-2 mt-3 sm:mt-0 sm:ml-4">
                <div className="text-sm">{user.name} <span className="text-xs text-gray-500">({user.type})</span></div>
                <button onClick={()=>{onSignout(); setOpen(false)}} className="px-3 py-1 border rounded text-sm">Sign out</button>
              </div>
            )}
          </div>
        </nav>
      </div>
    </header>
  );
}

/* ---------- Marketplace ---------- */
function Marketplace({user,onBuy,onLinkWithFarmer,onView}){
  const [products,setProducts]=useState(load('ag_products',[]));
  const [query,setQuery]=useState('');
  const [countryFilter,setCountryFilter]=useState('');
  useEffect(()=>save('ag_products',products),[products]);
  const filtered=products.filter(p=>{
    const passCountry=countryFilter?p.location.includes(countryFilter):true;
    const passQuery=!query||p.title.toLowerCase().includes(query.toLowerCase())||p.desc.toLowerCase().includes(query.toLowerCase());
    return passCountry&&passQuery;
  });
  return (
    <div className="max-w-6xl mx-auto p-4">
      <h2 className="text-2xl font-semibold text-green-700 mb-4">Marketplace</h2>
      <div className="flex flex-col sm:flex-row gap-2 mb-4">
        <input value={query} onChange={e=>setQuery(e.target.value)} placeholder="Search product..." className="border p-2 rounded flex-1"/>
        <select value={countryFilter} onChange={e=>setCountryFilter(e.target.value)} className="border p-2 rounded w-full sm:w-auto">
          <option value="">All Countries</option>
          {AFRICAN_COUNTRIES.map(c=><option key={c} value={c}>{c}</option>)}
        </select>
      </div>
      <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
        {filtered.map(p=>(
          <div key={p.id} className="bg-white rounded shadow p-4 flex flex-col justify-between">
            <img src={p.img} alt={p.title} className="w-full h-40 object-cover rounded mb-2"/>
            <div>
              <h3 className="text-lg font-semibold">{p.title}</h3>
              <p className="text-sm text-gray-600">{p.desc}</p>
              <p className="text-xs text-gray-500">{p.qty} â€¢ {p.location}</p>
              <p className="mt-2 font-bold">${p.price}</p>
              {p.temp!==undefined && (
                <div className={`inline-block mt-2 px-2 py-1 rounded text-xs ${p.temp>30?'bg-red-200 text-red-800':p.humidity>80?'bg-yellow-200 text-yellow-800':'bg-green-200 text-green-800'}`}>
                  ðŸŒ¡ {p.temp}Â°C â€¢ ðŸ’§ {p.humidity}%
                </div>
              )}
            </div>
            <div className="mt-3 flex flex-col sm:flex-row gap-2">
              <button onClick={()=>onBuy(p)} className="flex-1 bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700">Buy</button>
              <button onClick={()=>onView(p)} className="flex-1 bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700">View</button>
              {user?.type==='buyer' && (
                <button onClick={()=>onLinkWithFarmer(p)} className="flex-1 bg-indigo-600 text-white px-3 py-2 rounded hover:bg-indigo-700">Link with Farmer</button>
              )}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

/* ---------- Farmer Dashboard ---------- */
function FarmerDashboard({user}){
  const [products,setProducts]=useState(load('ag_products',[]));
  const [links,setLinks]=useState(load('ag_links',[]));
  const [users,setUsers]=useState(load('ag_users',[]));
  const [form,setForm]=useState({title:'',desc:'',qty:'',price:'',location:'',temp:25,humidity:60,img:'',iotImg:''});

  useEffect(()=>save('ag_products',products),[products]);
  useEffect(()=>save('ag_links',links),[links]);

  useEffect(()=>{
    const id = setInterval(()=>{
      setProducts(prev=>prev.map(p=>{
        if(p.farmerId!==user.id) return p;
        const temp=Math.max(15,Math.min(45, +(p.temp+(Math.random()*4-2)).toFixed(1)));
        const humidity=Math.max(30,Math.min(95, +(p.humidity+(Math.random()*6-3)).toFixed(1)));
        return {...p,temp,humidity};
      }))
    },5000);
    return ()=>clearInterval(id);
  },[user]);

  const myProducts=products.filter(p=>p.farmerId===user.id);
  const linkedBuyers=links.filter(l=>l.farmerId===user.id).map(l=>users.find(u=>u.id===l.buyerId)).filter(Boolean);

  function addProduct(e){
    e.preventDefault();
    const newP={id:uid('p'),...form,price:Number(form.price),farmerId:user.id};
    setProducts(prev=>[newP,...prev]);
    setForm({title:'',desc:'',qty:'',price:'',location:'',temp:25,humidity:60,img:'',iotImg:''});
    alert('Product added successfully!');
  }

  function removeProduct(id){
    if(!confirm('Remove product?')) return;
    setProducts(prev=>prev.filter(p=>p.id!==id));
  }

  return (
    <div className="max-w-6xl mx-auto p-4">
      <h2 className="text-2xl font-semibold text-green-700 mb-4">Farmer Dashboard</h2>

      {/* Add Product */}
      <section className="bg-white p-4 rounded shadow mb-6">
        <h3 className="font-semibold mb-2">Add Product</h3>
        <form onSubmit={addProduct} className="grid grid-cols-1 sm:grid-cols-2 gap-2">
          <input required value={form.title} onChange={e=>setForm({...form,title:e.target.value})} placeholder="Product title" className="p-2 border rounded"/>
          <input required value={form.qty} onChange={e=>setForm({...form,qty:e.target.value})} placeholder="Quantity (e.g. 100 bags)" className="p-2 border rounded"/>
          <input required value={form.price} onChange={e=>setForm({...form,price:e.target.value})} type="number" placeholder="Price" className="p-2 border rounded"/>
          <select required value={form.location} onChange={e=>setForm({...form,location:e.target.value})} className="p-2 border rounded">
            <option value="">Choose country / location</option>
            {AFRICAN_COUNTRIES.map(c=><option key={c} value={c}>{c}</option>)}
          </select>
          <textarea required value={form.desc} onChange={e=>setForm({...form,desc:e.target.value})} placeholder="Description" className="p-2 border rounded col-span-1 sm:col-span-2"/>
          <input value={form.img} onChange={e=>setForm({...form,img:e.target.value})} placeholder="Farmer image URL" className="p-2 border rounded"/>
          <input value={form.iotImg} onChange={e=>setForm({...form,iotImg:e.target.value})} placeholder="IoT image URL" className="p-2 border rounded"/>
          <div className="flex gap-2">
            <input value={form.temp} onChange={e=>setForm({...form,temp:Number(e.target.value)})} type="number" step="0.1" placeholder="Temp Â°C" className="p-2 border rounded w-full"/>
            <input value={form.humidity} onChange={e=>setForm({...form,humidity:Number(e.target.value)})} type="number" step="0.1" placeholder="Humidity %" className="p-2 border rounded w-full"/>
          </div>
          <button type="submit" className="bg-green-600 text-white py-2 px-3 rounded col-span-1 sm:col-span-2">Add Product</button>
        </form>
      </section>

      {/* My Products */}
      <section className="mb-6">
        <h3 className="text-lg font-semibold mb-2">My Products & IoT Status</h3>
        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
          {myProducts.length===0 && <div className="text-sm text-gray-600">No products yet.</div>}
          {myProducts.map(p=>(
            <div key={p.id} className={`p-4 rounded shadow ${p.temp>30?'bg-red-200':p.humidity>80?'bg-yellow-200':'bg-green-200'}`}>
              <img src={p.img} alt={p.title} className="w-full h-32 object-cover rounded mb-2"/>
              <h4 className="font-semibold">{p.title}</h4>
              <p className="text-xs text-gray-700">{p.qty} â€¢ {p.location}</p>
              <p className="mt-2">ðŸŒ¡ {p.temp}Â°C â€¢ ðŸ’§ {p.humidity}%</p>
              {p.iotImg && <img src={p.iotImg} alt="IoT" className="mt-2 w-full h-20 object-contain"/>}
              <button onClick={()=>removeProduct(p.id)} className="mt-2 bg-red-600 text-white px-2 py-1 rounded text-sm">Remove</button>
            </div>
          ))}
        </div>
      </section>

      {/* Linked Buyers */}
      <section>
        <h3 className="text-lg font-semibold mb-2">Linked Buyers</h3>
        {linkedBuyers.length===0 ? (
          <div className="text-sm text-gray-600">No buyers linked yet.</div>
        ):(
          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
            {linkedBuyers.map(b=>(
              <div key={b.id} className="p-3 bg-white rounded shadow flex justify-between items-center">
                <div>
                  <div className="font-semibold">{b.name}</div>
                  <div className="text-xs text-gray-500">{b.email}</div>
                </div>
                <button className="px-3 py-1 bg-indigo-600 text-white rounded text-sm">Message</button>
              </div>
            ))}
          </div>
        )}
      </section>
    </div>
  );
}

/* ---------- IoT Monitor ---------- */
function IotMonitor(){
  const [products,setProducts]=useState(load('ag_products',[]));
  const [countryFilter,setCountryFilter]=useState('');
  useEffect(()=>{
    const id=setInterval(()=>{
      setProducts(prev=>prev.map(p=>{
        const temp=Math.max(10,Math.min(45, +(p.temp+(Math.random()*4-2)).toFixed(1)));
        const humidity=Math.max(20,Math.min(95, +(p.humidity+(Math.random()*6-3)).toFixed(1)));
        return {...p,temp,humidity};
      }))
    },5000);
    return ()=>clearInterval(id);
  },[]);
  useEffect(()=>save('ag_products',products),[products]);
  const filtered=products.filter(p=>countryFilter?p.location.includes(countryFilter):true);
  return (
    <div className="max-w-6xl mx-auto p-4">
      <h2 className="text-2xl font-semibold text-green-700 mb-4">IoT Monitor & Spoilage Alerts</h2>
      <div className="flex gap-2 mb-4">
        <select value={countryFilter} onChange={e=>setCountryFilter(e.target.value)} className="border p-2 rounded">
          <option value="">All Countries</option>
          {AFRICAN_COUNTRIES.map(c=><option key={c} value={c}>{c}</option>)}
        </select>
      </div>
      <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
        {filtered.map(p=>(
          <div key={p.id} className={`p-4 rounded shadow ${p.temp>30?'bg-red-200':p.humidity>80?'bg-yellow-200':'bg-green-200'}`}>
            <h3 className="font-semibold">{p.title}</h3>
            <p className="text-sm text-gray-700">{p.location}</p>
            <p>ðŸŒ¡ {p.temp}Â°C â€¢ ðŸ’§ {p.humidity}%</p>
            {p.iotImg && <img src={p.iotImg} alt="IoT" className="mt-2 w-full h-20 object-contain"/>}
          </div>
        ))}
      </div>
    </div>
  );
}

/* ---------- Auth ---------- */
function Auth({onLogin}){
  const [mode,setMode]=useState('login');
  const [name,setName]=useState(''); const [email,setEmail]=useState(''); const [pw,setPw]=useState(''); const [type,setType]=useState('buyer');
  const usersKey='ag_users';

  function register(e){e.preventDefault();
    if(!name||!email||!pw){alert('Fill all fields');return;}
    const users=load(usersKey,[]);
    if(users.some(u=>u.email===email)){alert('Email already registered');return;}
    const u={id:uid('u'),name,email,password:pw,type}; users.push(u); save(usersKey,users);
    alert('Registration successful!'); onLogin(u);
  }

  function login(e){e.preventDefault();
    const users=load(usersKey,[]);
    const u=users.find(x=>x.email===email&&x.password===pw);
    if(!u){alert('Invalid credentials');return;}
    onLogin(u);
  }

  return (
    <div className="max-w-md mx-auto mt-8 p-6 bg-white rounded shadow">
      <h2 className="text-xl font-bold mb-4">{mode==='login'?'Login':'Register'}</h2>
      <form onSubmit={mode==='login'?login:register} className="space-y-3">
        {mode==='register'&&(<input value={name} onChange={e=>setName(e.target.value)} placeholder="Full name" className="w-full p-2 border rounded"/>)}
        <input value={email} onChange={e=>setEmail(e.target.value)} type="email" placeholder="Email" className="w-full p-2 border rounded"/>
        <input value={pw} onChange={e=>setPw(e.target.value)} type="password" placeholder="Password" className="w-full p-2 border rounded"/>
        {mode==='register'&&(
          <select value={type} onChange={e=>setType(e.target.value)} className="w-full p-2 border rounded">
            <option value="buyer">Buyer</option>
            <option value="farmer">Farmer</option>
          </select>
        )}
        <button type="submit" className="w-full bg-green-600 text-white py-2 rounded">{mode==='login'?'Login':'Create Account'}</button>
      </form>
      <div className="mt-3 text-sm text-center">
        {mode==='login'?(
          <span>New user? <button onClick={()=>setMode('register')} className="text-green-600 font-semibold">Register</button></span>
        ) : (
          <span>Already have an account? <button onClick={()=>setMode('login')} className="text-green-600 font-semibold">Login</button></span>
        )}
      </div>
    </div>
  );
}

/* ---------- Contact ---------- */
function Contact(){
  return (
    <div className="max-w-3xl mx-auto p-4">
      <h2 className="text-2xl font-semibold text-green-700 mb-4">Contact Us</h2>
      <p className="mb-2">Email: support@agrilink360.com</p>
      <p className="mb-2">Phone: +234 806 520 2102</p>
      <p className="mb-2">Address: Smart Farming Tech Hub, Lagos, Nigeria</p>
      <p className="mt-4">Weâ€™re here to help farmers and buyers across Africa reduce food waste and connect communities!</p>
    </div>
  );
}

/* ---------- Main App ---------- */
function App(){
  const [current,setCurrent]=useState('market');
  const [user,setUser]=useState(load('ag_currentUser',null));
  const [modal,setModal]=useState({show:false,title:'',message:''});

  function handleBuy(p){
    setModal({show:true,title:'Purchase Successful',message:`You have bought ${p.title} from ${p.location}`});
  }

  function handleLink(p){
    const buyerId=user.id;
    const links=load('ag_links',[]);
    if(links.some(l=>l.farmerId===p.farmerId && l.buyerId===buyerId)){alert('Already linked with this farmer'); return;}
    links.push({farmerId:p.farmerId,buyerId});
    save('ag_links',links);
    setModal({show:true,title:'Linked',message:`You are now linked with farmer of ${p.title}`});
  }

  function handleView(p){
    alert(`Product: ${p.title}\nDescription: ${p.desc}\nQuantity: ${p.qty}\nLocation: ${p.location}\nPrice: $${p.price}`);
  }

  function handleLogin(u){setUser(u); save('ag_currentUser',u); setCurrent('market');}
  function handleSignout(){setUser(null); localStorage.removeItem('ag_currentUser'); setCurrent('market');}

  return (
    <div className="min-h-screen flex flex-col">
      <Header current={current} setCurrent={setCurrent} user={user} onSignout={handleSignout} />
      <main className="flex-1">
        {current==='market' && <Marketplace user={user} onBuy={handleBuy} onLinkWithFarmer={handleLink} onView={handleView}/>}
        {current==='fdashboard' && user?.type==='farmer' && <FarmerDashboard user={user}/>}
        {current==='iot' && <IotMonitor />}
        {current==='contact' && <Contact />}
        {current==='auth' && !user && <Auth onLogin={handleLogin}/>}
      </main>
      <footer className="bg-gray-100 text-center p-4 text-sm text-gray-600">AgriLink360 Â© 2025 â€” Reducing Waste, Feeding Communities</footer>
      <Modal {...modal} onClose={()=>setModal({...modal,show:false})}/>
    </div>
  );
}

ReactDOM.render(<App/>,document.getElementById('root'));
</script>
</body>
</html>
